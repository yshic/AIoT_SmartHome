{"mode":"javascript","xmlText":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</variable><variable id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</variable></variables><block type=\"ai_event_forever\" id=\"476+L,b7`_XJF_cC5H%/\" x=\"-362\" y=\"-387\"><statement name=\"ONSTART\"><block type=\"ai_display_turnon_camera\" id=\"^;I1BCK?B=NMR`~Qu%#$\"><field name=\"camera\">environment</field><next><block type=\"variables_set\" id=\"G+BINiQpx60=ODKwqw|a\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field><value name=\"VALUE\"><block type=\"math_number\" id=\"e^;6o-UtZeTRV^w{xPe0\"><field name=\"NUM\">0</field></block></value><next><block type=\"variables_set\" id=\":c/OClDyteqm2;hV[9_F\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field><value name=\"VALUE\"><block type=\"math_number\" id=\"e6s43J)`oiRMr*^]yt6f\"><field name=\"NUM\">0</field></block></value><next><block type=\"ai_mqtt_connect_default_servers\" id=\"}9PMw(#sHAj!]4J.}5n{\"><field name=\"SERVER\">mqtt.ohstem.vn:8084</field><value name=\"USERNAME\"><shadow type=\"text\" id=\"qvKL{6w0~mv?sS.9FNd%\"><field name=\"TEXT\">1852837</field></shadow></value><value name=\"KEY\"><shadow type=\"text\" id=\"gH}zTr?rWp/CLnr@Q=nH\"><field name=\"TEXT\"></field></shadow></value><next><block type=\"ai_ml_image_classify_event_delay\" id=\")?QhwVW8=iGn3t%YkA@5\"><field name=\"delay\">1</field><field name=\"mirror\">TRUE</field><field name=\"model\"></field><statement name=\"event_handler\"><block type=\"ai_display_background\" id=\"b,}Q3/B+h-{;boX*C5,i\"><value name=\"COLOR\"><shadow type=\"colour_picker\" id=\"_geY]:q*;+n=Ph8jO_61\"><field name=\"COLOUR\">#ffffff</field></shadow></value><next><block type=\"ai_display_text\" id=\"xx;DuQil7@kz+nCK//pH\"><value name=\"TEXT\"><shadow type=\"text\" id=\"#$9[~^*f})7OEEmUJ_dO\"><field name=\"TEXT\">Hello</field></shadow><block type=\"ai_ml_classify_result\" id=\".LL8_BcA#hrhOO,=%6={\"><field name=\"type\">label</field><value name=\"order\"><shadow type=\"math_number\" id=\"Qdz~oZOZ;8(c^AO4xDi`\"><field name=\"NUM\">1</field></shadow></value></block></value><value name=\"X\"><shadow type=\"math_number\" id=\"Tp9#zX`KZ[tw@3nP@G3d\"><field name=\"NUM\">100</field></shadow></value><value name=\"Y\"><shadow type=\"math_number\" id=\"3$l!8]jy:`Q|=w%w7vfa\"><field name=\"NUM\">250</field></shadow></value><next><block type=\"controls_if\" id=\"`^%K5Z5-Cd#Ng*zx.+xi\"><value name=\"IF0\"><block type=\"ai_ml_classify_result_compare_confidence\" id=\"+Mb3mCoGE5~mu#GBM~C[\"><field name=\"compare\">&gt;</field><value name=\"index\"><shadow type=\"math_number\" id=\",)QPVmNew/*W{d|y`Xea\"><field name=\"NUM\">1</field></shadow></value><value name=\"threshold\"><shadow type=\"math_number\" id=\":N[;o:996P7Bn_AdB$k}\"><field name=\"NUM\">0.7</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"controls_if\" id=\"Nb.TDPDHCU{9W`6UE#U4\"><value name=\"IF0\"><block type=\"ai_ml_classify_result_compare_label\" id=\"JKgx2)?_JYG,Mh*^KKaL\"><value name=\"index\"><shadow type=\"math_number\" id=\"827ryV}`3!?3+xW}SOP8\"><field name=\"NUM\">1</field></shadow></value><value name=\"label\"><shadow type=\"text\" id=\"VdslSZJl;KNLzWHk9o.q\"><field name=\"TEXT\">NHAN</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"math_change\" id=\"+b_Zp$%8%cTk.tJ_+bwn\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field><value name=\"DELTA\"><shadow type=\"math_number\" id=\",DasCLe{kA;}VX3FHhaL\"><field name=\"NUM\">1</field></shadow></value><next><block type=\"variables_set\" id=\"7%a2]c0?kNU+,r_aJWg_\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field><value name=\"VALUE\"><block type=\"math_number\" id=\"LuRD#b@Gu`o_CL,D|[3;\"><field name=\"NUM\">0</field></block></value><next><block type=\"controls_if\" id=\"%y@!4~R9pbVU~oM3[O,T\"><value name=\"IF0\"><block type=\"logic_compare\" id=\"{}R%/MW3L7GFnQY7D{dS\"><field name=\"OP\">EQ</field><value name=\"A\"><block type=\"variables_get\" id=\"z3X-0`0N7[Iz!7rO_#DF\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field></block></value><value name=\"B\"><block type=\"math_number\" id=\"D^{LTrIqB|C{u*RqB|bq\"><field name=\"NUM\">3</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"}aINzytrB|.qCMz0S2_N\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field><value name=\"VALUE\"><block type=\"math_number\" id=\"6`yJ[TKU}MU$*uY+8v)H\"><field name=\"NUM\">0</field></block></value><next><block type=\"ai_mqtt_publish\" id=\"BFT*Z(1B3,#+.9/kCwXt\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"i;Eb3P1(Ud^s4nD9kdZm\"><field name=\"TEXT\">Hello NHÃ‚N</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"WvsQMY#uSoYnO$}Wq$%}\"><field name=\"TEXT\">V13</field></shadow></value><next><block type=\"ai_mqtt_publish\" id=\"bsIr%=+2L-mUdfzdUFq!\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"dW!w9Pn7hel*wjt!+hr~\"><field name=\"TEXT\">A</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"l~J_E7qrA*i25IUm(c0c\"><field name=\"TEXT\">V14</field></shadow></value></block></next></block></next></block></statement></block></next></block></next></block></statement><next><block type=\"controls_if\" id=\"J).ga;kGPqrC?`QKva$t\"><value name=\"IF0\"><block type=\"ai_ml_classify_result_compare_label\" id=\"(MPcS:*oj}eUyUv]pxjF\"><value name=\"index\"><shadow type=\"math_number\" id=\"],9x,CwWsGbT.BqROBSu\"><field name=\"NUM\">1</field></shadow></value><value name=\"label\"><shadow type=\"text\" id=\"v!gql5GOLA?5q*a1o?u|\"><field name=\"TEXT\">NHUNG</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"math_change\" id=\"/r|V#Pq(nCQI`G]_iN1s\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field><value name=\"DELTA\"><shadow type=\"math_number\" id=\"!!Qhk).!`yEG2b{XII2B\"><field name=\"NUM\">1</field></shadow></value><next><block type=\"variables_set\" id=\"Ee*Z6EZiR32rmHcOmc:x\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field><value name=\"VALUE\"><block type=\"math_number\" id=\"j4f-Zb,3@xcAKHP=bcgS\"><field name=\"NUM\">0</field></block></value><next><block type=\"controls_if\" id=\"3~HzNCej*p|%tatvzqPs\"><value name=\"IF0\"><block type=\"logic_compare\" id=\"r$(jaq`J#Wh3kx#*Y2*Q\"><field name=\"OP\">EQ</field><value name=\"A\"><block type=\"variables_get\" id=\"gMTRvj,_+pQr_qMz1wdr\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field></block></value><value name=\"B\"><block type=\"math_number\" id=\"v9i=yOW|FgAVwkwpk.w}\"><field name=\"NUM\">3</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"129=nFox|#NbU)GSUUDG\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field><value name=\"VALUE\"><block type=\"math_number\" id=\"MV8ax(XwtJ{c/iwp=fHD\"><field name=\"NUM\">0</field></block></value><next><block type=\"ai_mqtt_publish\" id=\"TQ/V*g8t;uuJ8!@=a9i6\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"O$I3FeNSfyt+ijQq30H=\"><field name=\"TEXT\">Hello NHUNG</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"w}~@:pW.%A|{J!|7i~tE\"><field name=\"TEXT\">V13</field></shadow></value><next><block type=\"ai_mqtt_publish\" id=\"}/r#7G_sLM~CrCw#BKd.\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"UGWqjTQy5X4^F^D~)^Sq\"><field name=\"TEXT\">B</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"G.dk]/rZm=C,6GS@?E|X\"><field name=\"TEXT\">V14</field></shadow></value></block></next></block></next></block></statement></block></next></block></next></block></statement><next><block type=\"controls_if\" id=\"zQoDK954s0!qA.+qY4sv\"><value name=\"IF0\"><block type=\"ai_ml_classify_result_compare_label\" id=\"xcX.$eoHfA:88AS~#!7C\"><value name=\"index\"><shadow type=\"math_number\" id=\"^(y}!v-!AYq|!3-?GD1w\"><field name=\"NUM\">1</field></shadow></value><value name=\"label\"><shadow type=\"text\" id=\"UT?!S_YWbdA!l{rRrdE|\"><field name=\"TEXT\">ANH_NEN</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"variables_set\" id=\"K8l[QV|f?UJ0vK(Ky@1-\"><field name=\"VAR\" id=\"_Vj8:TrDdFWvkzG/Fd4y\">counter_NHUNG</field><value name=\"VALUE\"><block type=\"math_number\" id=\"XPG.OBVK_Y3{u`%o+Tay\"><field name=\"NUM\">0</field></block></value><next><block type=\"variables_set\" id=\"x(Fh3hLV:a6QIS{s(@H#\"><field name=\"VAR\" id=\"x)(C|,{9@8cpC@Jn^!YO\">counter_TUAN</field><value name=\"VALUE\"><block type=\"math_number\" id=\"rb04J]0h?F?d@:6O_fC-\"><field name=\"NUM\">0</field></block></value><next><block type=\"ai_mqtt_publish\" id=\"X-cRR3O,;bU?z%3L`|AM\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"Im-oy^V$$T=Ml[4kwvam\"><field name=\"TEXT\">Z</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"!c)k+u?=6QAdk1;JB18C\"><field name=\"TEXT\">V14</field></shadow></value></block></next></block></next></block></statement></block></next></block></next></block></statement></block></next></block></next></block></statement></block></next></block></next></block></next></block></next></block></statement><statement name=\"FOREVER\"><block type=\"ai_display_image_camera\" id=\"~uZ(u^u%=-+zzjf`x%W*\"><field name=\"MIRROR\">TRUE</field><value name=\"X\"><shadow type=\"math_number\" id=\"b2gYq@Kbg6qkUW[t:;_s\"><field name=\"NUM\">0</field></shadow></value><value name=\"Y\"><shadow type=\"math_number\" id=\"BL!TPbe!Waw(mti^O_H5\"><field name=\"NUM\">0</field></shadow></value><value name=\"WIDTH\"><shadow type=\"math_number\" id=\"Y,Q:F}.S,:]ob#VZh3?Q\"><field name=\"NUM\">320</field></shadow></value><value name=\"HEIGHT\"><shadow type=\"math_number\" id=\"gM-OcIld:YJ~{j[e+EEn\"><field name=\"NUM\">240</field></shadow></value></block></statement></block></xml>","javascript":"var counter_TUAN, counter_NHUNG;\n\nfunction mqtt_check_connection() {\n  client.on(\"connect\", function () {\n    console.log(\"Connected\")\n  })\n}\n\nfunction mqtt_check_message() {\n  client.on(\"message\", (topic, message, packet) => {\n    console.log(\"Received Message: \" + message.toString() + \" on topic: \" + topic)\n  })\n}\n\nfunction mqtt_subscribe(topic) {\n  client.subscribe(options.username + /feeds/ + topic, { qos: 0 }, function (error, granted) {\n    if (error) {\n      console.log(error)\n    } else {\n      console.log(`${granted[0].topic} was subscribed`)\n    }\n  })\n}\n\nfunction mqtt_publish(topic, msg) {\n  client.publish(options.username + /feeds/ + topic, msg, { qos: 0, retain: false }, function (error) {\n    if (error) {\n      console.log(error)\n    } else {\n      console.log(\"Published\")\n    }\n  })\n}\n\nfunction loadAIModel(fromLocal, URI, modelType) { // modelType = 0:image, 1:audio, 2:pose\n  if (fromLocal) {\n    if (modelType == 0) {  // video classification model\n      const projects = JSON.parse(window.localStorage.getItem(\"ohstemai_projects\"));\n      let project;\n      if (projects && projects.data && Boolean(projects.data)) {\n        project = projects.data[URI];\n      }\n\n      parent.tf.loadLayersModel(\"indexeddb://\" + project.id).then((layersModel) => {\n        tmModel = new parent.tm.CustomMobileNet(layersModel, project.metadata);\n      }).catch((err) => console.log(err));\n    } else if (modelType == 1) {  // sound classification model\n      // Load the model first\n      const baseRecognizer = parent.spc.create(\"BROWSER_FFT\");\n      baseRecognizer\n        .ensureModelLoaded()\n        .then(() => {\n          tmModelAudio = baseRecognizer.createTransfer(URI);\n          console.log(`@tensorflow/speech-commands Transfer recognizer created (version ${parent.spc.version})`);\n          console.log(\"loading model\", URI);\n          return tmModelAudio.load();\n      })\n      .then(() => tmModelAudio.ensureModelLoaded())\n      .then(() => {\n        console.log(\"loaded model\", tmModelAudio);\n        // Start classifying\n        classifySound(true);\n      })\n      .catch((err) => console.log(err));\n    }\n  } else {\n    if (modelType == 0) {\n      imageClassifier = ml5.imageClassifier(URI + \"model.json\");\n    } else {\n      soundClassifier = ml5.soundClassifier(URI + \"model.json\");\n    }\n  }\n}\n\nfunction classifyVideoDelay(mirror, useLocalModel, continuous, delay) {\n  if (!parent || Boolean(parent.isStopCode)) {return;}\n\n  let videoImage = mirror?ml5.flipImage(videoCamera):videoCamera;\n  if (useLocalModel) {\n    if (tmModel) {\n      tmModel.predict(mirror?videoImage.canvas:videoImage.elt).then((predictions) => {\n        classifyVideoGotResult(undefined, predictions.sort((a, b) => b.probability - a.probability).map((p) => ({ label: p.className, confidence: p.probability })));\n        if (continuous) {\n          if (delay == 0) {\n            classifyVideoDelay(mirror, useLocalModel, continuous, 0);\n          }\n          else {\n            sleep(aiTimeDelay).then(() => classifyVideoDelay(mirror, useLocalModel, continuous, aiTimeDelay));\n          }\n        }\n      }).catch((err) => classifyVideoGotResult(err, undefined));\n    } else {\n      setTimeout(classifyVideoDelay, 500, mirror, useLocalModel, continuous);\n    }\n  } else {\n    imageClassifier.classify(videoImage, (err, results) => {\n      if (err) {\n        classifyVideoGotResult(err, undefined);\n      } else {\n        classifyVideoGotResult(undefined, results);\n        if (continuous) {\n          if (delay == 0) {\n            classifyVideoDelay(mirror, useLocalModel, continuous, 0);\n          }\n          else {\n            sleep(aiTimeDelay).then(() => classifyVideoDelay(mirror, useLocalModel, continuous, aiTimeDelay));\n          }\n        }\n      }\n    });\n  }\n\n  if (mirror) videoImage.remove();\n}\n\nfunction classifyVideoGotResult(error, classifyResults) {\n  if (error) {\n    console.error(error);\n    return;\n  }\n\n  // handle result here\n  background('#ffffff');\n  text((classifyResults[0].label) , 100, 250);\n  if (classifyResults[0].confidence.toFixed(2) > 0.7) {\n    if (classifyResults[0].label == 'NHAN') {\n      counter_TUAN = (typeof counter_TUAN === 'number' ? counter_TUAN : 0) + 1;\n      counter_NHUNG = 0;\n      if (counter_TUAN == 3) {\n        counter_TUAN = 0;\n        mqtt_publish('V13', 'Hello NHÃ‚N')\n        mqtt_publish('V14', 'A')\n      }\n    }\n    if (classifyResults[0].label == 'NHUNG') {\n      counter_NHUNG = (typeof counter_NHUNG === 'number' ? counter_NHUNG : 0) + 1;\n      counter_TUAN = 0;\n      if (counter_NHUNG == 3) {\n        counter_NHUNG = 0;\n        mqtt_publish('V13', 'Hello NHUNG')\n        mqtt_publish('V14', 'B')\n      }\n    }\n    if (classifyResults[0].label == 'ANH_NEN') {\n      counter_NHUNG = 0;\n      counter_TUAN = 0;\n      mqtt_publish('V14', 'Z')\n    }\n  }\n\n}\n\nfunction sleep(s) {\n  ms = s * 1000\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\n\nlet videoCamera;\nconst clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8);\n\nconst host = 'wss://mqtt.ohstem.vn:8084'\n\nconst options = {clean: true,connectTimeout: 4000,clientId: clientId,username: '1852837',password: ''}\n\nconst client = mqtt.connect(host, options);\n\nlet imageClassifier;\n\nlet soundClassifier;\n\nlet aiTimeDelay;\nlet tmModel;\n\nfunction preload() {\n  loadAIModel(true, \"\", 0);\n}\n\nfunction setup() {\n  createCanvas(window.parent.document.getElementById('js-runner-container').offsetWidth-50, window.parent.document.getElementById('js-runner-container').offsetHeight-50);\n    videoCamera = createCapture({audio: false, video: {facingMode: \"environment\"}});\n  videoCamera.size(width, height);\n  videoCamera.hide();\n  counter_TUAN = 0;\n  counter_NHUNG = 0;\n\n  mqtt_check_connection()\n  aiTimeDelay = 1\n  classifyVideoDelay(true, true, true, aiTimeDelay);\n\n}\n\nfunction draw() {\n  let flippedImage = ml5.flipImage(videoCamera);\n  image(flippedImage, 0, 0, 320, 240);\n  flippedImage.remove();\n\n}\n","name":"AIoT_FaceID","extensions":[],"device":"ai"}